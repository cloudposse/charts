sudo: required
addons:
  apt:
    packages:
    - git
    - make
    - curl

env:
  - DOCKER_IMAGE_NAME=cloudposse/route53-kubernetes

script:
- make --directory incubator/library lint
- make --directory incubator package
- make --directory incubator index
- make --directory stable/library lint
- make --directory stable package
- make --directory stable index

before_deploy:
- |-
  if [ ! -z "$TRAVIS_TAG" ]; then \
    export BUCKET=$DEV_BUCKET
    export DESTINATON=$TRAVIS_TAG
  fi

- |-
  if [ ! -z "$TRAVIS_PULL_REQUEST_BRANCH" ]; then \
    export BUCKET=$DEV_BUCKET
    export DESTINATON="pr-${TRAVIS_TAG}"
  fi

- |-
  if [[ -z "$TRAVIS_PULL_REQUEST_BRANCH" && ! -z "$TRAVIS_BRANCH" ]]; then \
    export BUCKET=$DEV_BUCKET
    export DESTINATON=$TRAVIS_BRANCH
  fi

- |-
  if [[ -z "$TRAVIS_TAG"  &&  -z "$TRAVIS_PULL_REQUEST_BRANCH"  &&  -z "$TRAVIS_BRANCH" ]]; then \
    export BUCKET=$MAIN_BUCKET
    export DESTINATON=""
  fi

- |-
  if [[ -z "$TRAVIS_PULL_REQUEST_BRANCH" ]]  && [[ "$TRAVIS_BRANCH" == "master" ]]; then \
    export BUCKET=$MAIN_BUCKET
    export DESTINATON=""
  fi

deploy:

  - provider: s3
    access_key_id: $AWS_KEY_ID
    secret_access_key: $AWS_ACCESS_KEY
    bucket: $BUCKET
    skip_cleanup: true
    upload-dir: $DESTINATON/incubator
    local-dir: incubator/packages

  - provider: s3
    access_key_id: $AWS_KEY_ID
    secret_access_key: $AWS_ACCESS_KEY
    bucket: $BUCKET
    skip_cleanup: true
    upload-dir: $DESTINATON/stable
    local-dir: stable/packages

