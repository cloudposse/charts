sudo: required
addons:
  apt:
    packages:
    - git
    - make
    - curl

install:
- curl https://kubernetes-helm.storage.googleapis.com/helm-v2.1.3-linux-amd64.tar.gz | tar xvz
- mv linux-amd64/helm /usr/local/bin/helm

script:
- make lint package index

before_deploy:
- |-
  if [ ! -z "$TRAVIS_TAG" ]; then \
    export BUCKET=$DEV_BUCKET
    export DESTINATON=$TRAVIS_TAG
  fi

- |-
  if [ ! -z "$TRAVIS_PULL_REQUEST_BRANCH" ]; then \
    export BUCKET=$DEV_BUCKET
    export DESTINATON="pr-${TRAVIS_TAG}"
  fi

- |-
  if [[ -z "$TRAVIS_PULL_REQUEST_BRANCH" && ! -z "$TRAVIS_BRANCH" ]]; then \
    export BUCKET=$DEV_BUCKET
    export DESTINATON=$TRAVIS_BRANCH
  fi

- |-
  if [[ -z "$TRAVIS_TAG"  &&  -z "$TRAVIS_PULL_REQUEST_BRANCH"  &&  -z "$TRAVIS_BRANCH" ]]; then \
    export BUCKET=$MAIN_BUCKET
    export DESTINATON=""
  fi

- |-
  if [[ -z "$TRAVIS_PULL_REQUEST_BRANCH" ]]  && [[ "$TRAVIS_BRANCH" == "master" ]]; then \
    export BUCKET=$MAIN_BUCKET
    export DESTINATON=""
  fi

deploy:

  - provider: s3
    access_key_id: $AWS_KEY_ID
    secret_access_key: $AWS_ACCESS_KEY
    bucket: $BUCKET
    skip_cleanup: true
    upload-dir: $DESTINATON/incubator
    local-dir: incubator/packages

  - provider: s3
    access_key_id: $AWS_KEY_ID
    secret_access_key: $AWS_ACCESS_KEY
    bucket: $BUCKET
    skip_cleanup: true
    upload-dir: $DESTINATON/stable
    local-dir: stable/packages

